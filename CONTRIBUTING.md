# Contributing to Coupon Causal Impact Analysis

Thank you for your interest in contributing! This document provides guidelines and instructions for contributing to the project.

## Development Setup

### 1. Clone the Repository

```bash
git clone https://github.com/MysterionRise/retail-causal-impact.git
cd retail-causal-impact
```

### 2. Create a Virtual Environment

```bash
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

### 3. Install Dependencies

```bash
# Install in development mode
pip install -e ".[dev]"

# Or use requirements files
pip install -r requirements-dev.txt
```

### 4. Setup Pre-commit Hooks (Optional but Recommended)

```bash
pip install pre-commit
pre-commit install
```

This will run linting and formatting checks before each commit.

## Development Workflow

### Running Tests

```bash
# Run all tests
make test

# Or with pytest
python -m pytest tests/ -v

# Run specific test
python -m pytest tests/test_synth_recovery.py::test_ate_recovery_aipw -v

# Run with coverage
python -m pytest tests/ --cov=src/coupon_causal --cov-report=html
# View coverage report: open htmlcov/index.html
```

### Code Quality

```bash
# Linting
make lint
# Or manually:
ruff check src/ tests/ scripts/
mypy src/coupon_causal/

# Auto-fix linting issues
ruff check src/ tests/ scripts/ --fix
```

### Running the Pipeline

```bash
# Quick test with synthetic data
python test_quick.py

# Full pipeline
make all

# Individual stages
make data
make train
make report
```

## Contribution Guidelines

### Branching Strategy

- `main` - Production-ready code
- `claude/*` - Feature branches (auto-generated by Claude Code)
- Create feature branches from `main`: `git checkout -b feature/your-feature-name`

### Pull Request Process

1. **Create a feature branch**
   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **Make your changes**
   - Write clean, documented code
   - Add tests for new functionality
   - Update documentation as needed

3. **Run tests and linting**
   ```bash
   make test
   make lint
   ```

4. **Commit your changes**
   ```bash
   git add .
   git commit -m "feat: add your feature description"
   ```

   Use conventional commit messages:
   - `feat:` - New feature
   - `fix:` - Bug fix
   - `docs:` - Documentation changes
   - `test:` - Test additions or changes
   - `refactor:` - Code refactoring
   - `chore:` - Maintenance tasks

5. **Push and create PR**
   ```bash
   git push origin feature/your-feature-name
   ```
   Then create a Pull Request on GitHub.

### Code Standards

- **Type hints:** Use type hints for function signatures
- **Docstrings:** All public functions should have Google-style docstrings
- **Naming:** Follow PEP 8 naming conventions
- **Line length:** Max 100 characters (configured in ruff)
- **Testing:** Aim for >70% code coverage for new code

### Example Docstring

```python
def estimate_ate(Y: np.ndarray, T: np.ndarray, method: str = "ipw") -> float:
    """
    Estimate average treatment effect.

    Args:
        Y: Outcome vector (n_samples,)
        T: Treatment indicator (n_samples,)
        method: Estimation method ('naive', 'ipw', 'aipw')

    Returns:
        Estimated ATE value

    Raises:
        ValueError: If method is not recognized
    """
    ...
```

## Testing Guidelines

### Writing Tests

1. **Test files:** Place in `tests/` directory, named `test_*.py`
2. **Test functions:** Name with `test_*` prefix
3. **Fixtures:** Use pytest fixtures for shared setup
4. **Assertions:** Use descriptive assertion messages

### Test Categories

- **Unit tests:** Test individual functions in isolation
- **Integration tests:** Test end-to-end workflows
- **Validation tests:** Test against known ground truth (synthetic data)

### Example Test

```python
def test_ate_recovery_on_synthetic_data():
    """Test that ATE estimator recovers true ATE on synthetic data."""
    # Generate data with known ATE
    df, ground_truth = generate_synthetic_coupon_data(true_ate=15.0)

    # Estimate ATE
    estimated_ate = estimate_ate(df['outcome'], df['treatment'])

    # Check recovery within tolerance
    assert abs(estimated_ate - ground_truth['true_ate']) < 3.0
```

## Project Structure

```
retail-causal-impact/
├── src/coupon_causal/     # Main package
│   ├── data.py           # Data loading & generation
│   ├── features.py       # Feature engineering
│   ├── propensity.py     # Propensity models
│   ├── ate.py            # ATE estimation
│   ├── cate.py           # CATE estimation
│   ├── policy.py         # Policy learning
│   ├── balance.py        # Balance diagnostics
│   ├── refute.py         # Refutation tests
│   ├── viz.py            # Visualization
│   └── utils.py          # Utilities
├── scripts/              # CLI tools
├── tests/                # Test suite
├── notebooks/            # Jupyter notebooks
└── app/                  # Streamlit dashboard
```

## Common Tasks

### Adding a New Causal Estimator

1. Add implementation to appropriate module (`ate.py`, `cate.py`)
2. Add tests to `tests/test_synth_recovery.py`
3. Update documentation
4. Add example to notebooks

### Adding a New Visualization

1. Add function to `viz.py`
2. Follow existing plotting conventions
3. Add example usage to notebooks
4. Update reports generation in pipeline

### Debugging Tips

```bash
# Run with verbose output
python -m pytest tests/ -vv -s

# Run specific test with debugging
python -m pytest tests/test_synth_recovery.py::test_ate_recovery_aipw -vv -s --pdb

# Check data generation
python -c "from coupon_causal import data; df, gt = data.generate_synthetic_coupon_data(n_samples=100); print(df.head())"
```

## Getting Help

- **Issues:** Open a GitHub issue for bugs or feature requests
- **Discussions:** Use GitHub Discussions for questions
- **Documentation:** Check README.md and docstrings

## License

By contributing, you agree that your contributions will be licensed under the MIT License.
