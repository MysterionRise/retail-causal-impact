name: CI

on:
  push:
    branches: [ main, master, claude/** ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12', '3.13']
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Create required directories
      run: |
        mkdir -p data/{raw,interim,processed}
        mkdir -p reports/{figures,tables}
        mkdir -p models

    - name: Lint with ruff
      run: |
        ruff check src/ tests/ scripts/ --output-format=github
      continue-on-error: true

    - name: Type check with mypy
      run: |
        mypy src/coupon_causal/ --ignore-missing-imports
      continue-on-error: true

    - name: Run tests with pytest
      run: |
        pytest tests/ -v --tb=short --cov=src/coupon_causal --cov-report=xml --cov-report=term-missing

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        verbose: true
      continue-on-error: true

    - name: Quick smoke test
      run: |
        python -c "import sys; sys.path.insert(0, 'src'); from coupon_causal import data, utils; print('✓ Package imports successfully')"

  build:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: |
        python -m build

    - name: Check package
      run: |
        twine check dist/*

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages
        path: dist/
        retention-days: 7

  integration-test:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Setup directories
      run: |
        make setup

    - name: Run data generation stage
      run: |
        python -m scripts.run_pipeline --config config/default.yaml --data_source synth --stage data

    - name: Verify data was created
      run: |
        test -f data/processed/coupon_data.parquet && echo "✓ Data file created" || (echo "✗ Data file missing" && exit 1)

    - name: Run estimation stage (quick mode)
      run: |
        python -c '
        import sys
        sys.path.insert(0, "src")
        from coupon_causal import data, features, propensity, ate, utils
        import pandas as pd
        df = pd.read_parquet("data/processed/coupon_data.parquet")
        df = df.head(500)
        config = utils.load_config("config/default.yaml")
        X, T, Y, fe = features.prepare_features(df, config["features"], fit=True)
        prop_model = propensity.PropensityModel(model_type="logistic")
        prop_model.fit(X, T)
        ate_naive = ate.estimate_ate_naive(Y, T)
        ate_ipw = ate.estimate_ate_ipw(Y, T, prop_model.propensity_scores_)
        print(f"Naive ATE: ${ate_naive:.2f}, IPW ATE: ${ate_ipw:.2f}")
        print("Integration test passed!")
        '

    - name: Test CLI smoke test
      run: |
        python -m scripts.run_pipeline --help
        python -m scripts.score_policy --help
